#!/usr/bin/env python3
"""
Biomni + DeepSeek å®é™…ä»»åŠ¡æ¼”ç¤º

æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨Biomniæ‰§è¡ŒçœŸå®çš„ç”Ÿç‰©åŒ»å­¦ä»»åŠ¡
"""

import os
import sys

# å–æ¶ˆä»£ç†è®¾ç½®
for var in ['http_proxy', 'https_proxy', 'HTTP_PROXY', 'HTTPS_PROXY', 'all_proxy', 'ALL_PROXY']:
    os.environ.pop(var, None)

# è®¾ç½®DeepSeeké…ç½®
os.environ['OPENAI_API_KEY'] = 'sk-6f73c67f11d5469e846aba019b0f3530'
os.environ['LLM_SOURCE'] = 'Custom'
os.environ['BIOMNI_LLM'] = 'deepseek-chat'
os.environ['CUSTOM_MODEL_BASE_URL'] = 'https://api.deepseek.com'
os.environ['CUSTOM_MODEL_API_KEY'] = 'sk-6f73c67f11d5469e846aba019b0f3530'

print("=" * 70)
print("ğŸ§¬ Biomni + DeepSeek ç”Ÿç‰©åŒ»å­¦ä»»åŠ¡æ¼”ç¤º")
print("=" * 70)

# ä»»åŠ¡é€‰æ‹©
print("\nè¯·é€‰æ‹©è¦æ¼”ç¤ºçš„ä»»åŠ¡:\n")
print("1. CRISPRç­›é€‰å®éªŒè®¾è®¡")
print("2. è¯ç‰©åˆ†å­ADMETæ€§è´¨é¢„æµ‹")
print("3. åŸºå› åŠŸèƒ½åˆ†æ (TP53)")
print("4. å•ç»†èƒRNAæµ‹åºåˆ†æè®¾è®¡")
print("5. è›‹ç™½è´¨ç»“æ„é¢„æµ‹å»ºè®®")
print("6. ç®€å•æµ‹è¯•ä»»åŠ¡")

choice = input("\nè¯·è¾“å…¥é€‰é¡¹ (1-6, é»˜è®¤6): ").strip() or "6"

# å®šä¹‰ä»»åŠ¡
tasks = {
    "1": {
        "name": "CRISPRç­›é€‰å®éªŒè®¾è®¡",
        "task": """
è®¾è®¡ä¸€ä¸ªå…¨åŸºå› ç»„CRISPR-Cas9ç­›é€‰å®éªŒï¼Œç”¨äºè¯†åˆ«è°ƒèŠ‚ä¸‰é˜´æ€§ä¹³è…ºç™Œ
å¯¹PD-1æŠ‘åˆ¶å‰‚è€è¯æ€§çš„å…³é”®åŸºå› ã€‚

è¯·æä¾›:
1. å®éªŒè®¾è®¡å’Œå¯¹ç…§ç»„è®¾ç½®
2. sgRNAæ–‡åº“é€‰æ‹©å»ºè®®
3. ç»†èƒç³»å’ŒåŸ¹å…»æ¡ä»¶
4. ç­›é€‰æµç¨‹å’Œæ£€æµ‹æ–¹æ³•
5. æ•°æ®åˆ†æç­–ç•¥
6. é¢„æœŸç»“æœå’ŒéªŒè¯æ–¹æ³•
"""
    },
    "2": {
        "name": "è¯ç‰©åˆ†å­ADMETæ€§è´¨é¢„æµ‹",
        "task": """
é¢„æµ‹ä»¥ä¸‹åŒ–åˆç‰©çš„ADMETæ€§è´¨:

é˜¿å¸åŒ¹æ— (Aspirin)
SMILES: CC(=O)Oc1ccccc1C(=O)O

è¯·åˆ†æ:
1. å¸æ”¶ (Absorption) - ç”Ÿç‰©åˆ©ç”¨åº¦ã€æº¶è§£åº¦
2. åˆ†å¸ƒ (Distribution) - è›‹ç™½ç»“åˆç‡ã€ç»„ç»‡åˆ†å¸ƒ
3. ä»£è°¢ (Metabolism) - ä¸»è¦ä»£è°¢é€”å¾„ã€é…¶
4. æ’æ³„ (Excretion) - æ¸…é™¤ç‡ã€æ’æ³„é€”å¾„
5. æ¯’æ€§ (Toxicity) - å·²çŸ¥æ¯’æ€§ã€å‰¯ä½œç”¨
6. è¯ç‰©ç›¸ä¼¼æ€§ (Lipinskiè§„åˆ™ç­‰)
"""
    },
    "3": {
        "name": "åŸºå› åŠŸèƒ½åˆ†æ (TP53)",
        "task": """
å…¨é¢åˆ†æTP53åŸºå›  (è‚¿ç˜¤è›‹ç™½p53):

è¯·æä¾›:
1. åŸºå› åŸºæœ¬ä¿¡æ¯ (ä½ç½®ã€å¤§å°ã€ç»“æ„)
2. è›‹ç™½åŠŸèƒ½å’Œåˆ†å­æœºåˆ¶
3. ç›¸å…³ç–¾ç—…å’Œè¡¨å‹
4. å¸¸è§è‡´ç—…çªå˜
5. ä¸´åºŠæ„ä¹‰å’Œæ²»ç–—é¶ç‚¹
6. æœ€æ–°ç ”ç©¶è¿›å±•
7. ç›¸å…³æ•°æ®åº“å’Œèµ„æº
"""
    },
    "4": {
        "name": "å•ç»†èƒRNAæµ‹åºåˆ†æè®¾è®¡",
        "task": """
è®¾è®¡ä¸€ä¸ªå•ç»†èƒRNAæµ‹åºåˆ†ææµç¨‹ï¼Œç”¨äºç ”ç©¶è‚¿ç˜¤å¾®ç¯å¢ƒ:

è¯·æä¾›:
1. å®éªŒè®¾è®¡å’Œæ ·æœ¬å‡†å¤‡
2. æµ‹åºå¹³å°é€‰æ‹©å»ºè®®
3. æ•°æ®é¢„å¤„ç†æ­¥éª¤
4. è´¨æ§æ ‡å‡†
5. ç»†èƒç±»å‹æ³¨é‡Šæ–¹æ³•
6. å·®å¼‚è¡¨è¾¾åˆ†æ
7. è½¨è¿¹æ¨æ–­å»ºè®®
8. å¯è§†åŒ–æ–¹æ¡ˆ
9. å·¥å…·å’Œè½¯ä»¶æ¨è
"""
    },
    "5": {
        "name": "è›‹ç™½è´¨ç»“æ„é¢„æµ‹å»ºè®®",
        "task": """
ä¸ºä»¥ä¸‹è›‹ç™½è´¨æä¾›ç»“æ„é¢„æµ‹å’Œåˆ†æå»ºè®®:

ç›®æ ‡: SARS-CoV-2 åˆºçªè›‹ç™½ (Spike Protein)
åºåˆ—é•¿åº¦: ~1273 aa

è¯·æä¾›:
1. ç»“æ„é¢„æµ‹å·¥å…·æ¨è (AlphaFold, RoseTTAFoldç­‰)
2. ç»“æ„éªŒè¯æ–¹æ³•
3. åŠŸèƒ½åŸŸè¯†åˆ«
4. ä¸ACE2å—ä½“ç»“åˆä½ç‚¹åˆ†æ
5. çªå˜å½±å“é¢„æµ‹å»ºè®®
6. è¯ç‰©é¶ç‚¹è¯†åˆ«
"""
    },
    "6": {
        "name": "ç®€å•æµ‹è¯•ä»»åŠ¡",
        "task": """
ç®€è¦ä»‹ç»CRISPR-Cas9åŸºå› ç¼–è¾‘æŠ€æœ¯:

è¯·ç”¨ä¸­æ–‡å›ç­”ï¼ŒåŒ…æ‹¬:
1. æŠ€æœ¯åŸç†
2. ä¸»è¦åº”ç”¨
3. ä¼˜åŠ¿å’Œå±€é™æ€§
4. å½“å‰æŒ‘æˆ˜

è¯·æ§åˆ¶åœ¨300å­—ä»¥å†…ã€‚
"""
    }
}

selected = tasks.get(choice, tasks["6"])

print(f"\n{'=' * 70}")
print(f"ğŸ“‹ ä»»åŠ¡: {selected['name']}")
print(f"{'=' * 70}")

print("\nâ³ æ­£åœ¨åˆå§‹åŒ–Biomni...")

try:
    from biomni.llm import get_llm
    from langchain_core.messages import HumanMessage, SystemMessage

    # åˆ›å»ºLLMå®ä¾‹
    print("âœ“ LLMå®ä¾‹åˆ›å»ºæˆåŠŸ")

    # åˆ›å»ºBiomnié£æ ¼çš„ä»£ç†ï¼ˆç®€åŒ–ç‰ˆï¼Œä¸ä½¿ç”¨å®Œæ•´çš„A1ä»¥é¿å…ä¸‹è½½å¤§æ•°æ®ï¼‰
    print("\nğŸ¤– å¼€å§‹æ‰§è¡Œä»»åŠ¡...")
    print(f"{'=' * 70}")
    print("ä»»åŠ¡æè¿°:")
    print(selected['task'])
    print(f"{'=' * 70}")
    print("\nğŸ’¡ DeepSeekæ­£åœ¨åˆ†æ...\n")

    # åˆ›å»ºç³»ç»Ÿæç¤º - æ¨¡æ‹ŸBiomniçš„ä¸“ä¸šæ€§
    system_prompt = """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç”Ÿç‰©åŒ»å­¦AIåŠ©æ‰‹ï¼ˆBiomniï¼‰ã€‚
ä½ å…·æœ‰å¹¿æ³›çš„ç”Ÿç‰©åŒ»å­¦çŸ¥è¯†ï¼ŒåŒ…æ‹¬ï¼š
- åˆ†å­ç”Ÿç‰©å­¦å’Œé—ä¼ å­¦
- CRISPRåŸºå› ç¼–è¾‘æŠ€æœ¯
- è¯ç‰©è®¾è®¡å’ŒADMETé¢„æµ‹
- ç”Ÿç‰©ä¿¡æ¯å­¦å’Œæ•°æ®åˆ†æ
- å•ç»†èƒæµ‹åºæŠ€æœ¯
- è›‹ç™½è´¨ç»“æ„å’ŒåŠŸèƒ½

è¯·æä¾›å‡†ç¡®ã€è¯¦ç»†ã€ä¸“ä¸šçš„å›ç­”ã€‚
å¿…è¦æ—¶å¼•ç”¨ç›¸å…³æ–¹æ³•å’Œå·¥å…·ã€‚
ä½¿ç”¨æ¸…æ™°çš„æ ¼å¼ç»„ç»‡ç­”æ¡ˆã€‚"""

    # åˆ›å»ºLLM
    llm = get_llm(
        model="deepseek-chat",
        source="Custom",
        base_url="https://api.deepseek.com",
        api_key="sk-6f73c67f11d5469e846aba019b0f3530",
        temperature=0.7
    )

    # æ‰§è¡Œä»»åŠ¡
    messages = [
        SystemMessage(content=system_prompt),
        HumanMessage(content=selected['task'])
    ]

    # è°ƒç”¨LLM
    response = llm.invoke(messages)

    print("ğŸ“Š åˆ†æç»“æœ:")
    print(f"{'=' * 70}")
    print(response.content)
    print(f"{'=' * 70}")

    print("\nâœ… ä»»åŠ¡å®Œæˆï¼")

    # æ˜¾ç¤ºä½¿ç”¨ç»Ÿè®¡ï¼ˆä¼°ç®—ï¼‰
    print("\nğŸ“ˆ ä»»åŠ¡ä¿¡æ¯:")
    print(f"  æ¨¡å‹: deepseek-chat")
    print(f"  API: https://api.deepseek.com")
    print(f"  æˆæœ¬: ~Â¥0.01-0.05 (ä¼°ç®—)")

    print("\nğŸ’¡ æç¤º:")
    print("  - è¿™æ˜¯ä½¿ç”¨DeepSeek APIçš„æ¼”ç¤º")
    print("  - å®Œæ•´çš„Biomni A1ä»£ç†å¯ä»¥æ‰§è¡Œæ›´å¤æ‚çš„ä»»åŠ¡")
    print("  - å®Œæ•´ç‰ˆæœ¬ä¼šè‡ªåŠ¨ä½¿ç”¨æ•°æ®åº“ã€å·¥å…·å’Œä»£ç æ‰§è¡Œ")

    print("\nğŸ”— åç»­æ­¥éª¤:")
    print("  - å¦‚æœéœ€è¦ä½¿ç”¨å®Œæ•´BiomniåŠŸèƒ½ï¼Œè¿è¡Œ:")
    print("    from biomni.agent import A1")
    print("    agent = A1(path='./data')")
    print("    agent.go('ä½ çš„ä»»åŠ¡')")

except Exception as e:
    print(f"\nâŒ é”™è¯¯: {e}")
    import traceback
    traceback.print_exc()

    print("\nğŸ’¡ å¯èƒ½çš„åŸå› :")
    print("  1. éœ€è¦å®‰è£…biomni: pip install biomni")
    print("  2. éœ€è¦å®‰è£…langchain-openai: pip install langchain-openai")
    print("  3. ç½‘ç»œè¿æ¥é—®é¢˜")

print("\n" + "=" * 70)
print("æ¼”ç¤ºç»“æŸ")
print("=" * 70)
